<?php/** * Description of ProductController * @author : Trung Tong * @since Oct 19, 2012 */class ProductController extends AppController {        public $name = 'Product';    public $uses = array('Catproduct', 'Product','Email','Hang');        public function index($id = 0,$hang=0) {		//echo "vao"; die;		//echo $id; echo '-'.$hang; die;		        $typeName = $this->Catproduct->findById($id);        $this->set('typeName', $typeName);		        $hang1 = $this->Hang->findById($hang);        $this->set('hang', $hang1);				if(($id!=0) && ($hang==0)) {						$mang=array();$i=0;				$mang[$i++]=$id;				$cat=$this->Catproduct->find('list',array('conditions'=>array('Catproduct.status'=>1,'Catproduct.parent_id'=>$id)));						foreach($cat as $k=>$v) {		$mang[$i++]=$k;				}		        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,              'Product.cat_id' => $mang,			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );						}		elseif($id==0 && $hang!=0) {				 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,              'Product.hang_id' => $hang,			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );				}		elseif($id!=0 && $hang!=0){				$mang=array();$i=0;		$mang[$i++]=$id;		$cat=$this->Catproduct->find('list',array('conditions'=>array('Catproduct.status'=>1,'Catproduct.parent_id'=>$id)));		foreach($cat as $k=>$v) {		$mang[$i++]=$k;				}						 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,              'Product.hang_id' => $hang,              'Product.cat_id' => $mang,			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );		}				else {		 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,           			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );		}						        $listProduct = $this->paginate('Product');        $this->set('product', $listProduct);    }        public function detail($id = null) {        $detailNews = $this->Product->findById($id);        $this->set('detailNews', $detailNews);		$this->set('cat',$this->Catproduct->findById($detailNews['Product']['cat_id']));						  $this->paginate = array(            'conditions' => array(              'Product.status' => 1,              'Product.cat_id' => $detailNews['Product']['cat_id'],           			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );				  $listProduct = $this->paginate('Product');        $this->set('product', $listProduct);    }		//shopping	    function addshopingcart($id=null){	     $this->autoRender=false;	$url='';		 	 $shopingcart=$this->Session->read('shopingcart');	 	 if(isset($shopingcart[$id]))		 {		 				 $shopingcart[$id]['sl']= $shopingcart[$id]['sl']+1;			 $shopingcart[$id]['total']= $shopingcart[$id]['price']*$shopingcart[$id]['sl'];						 $this->Session->write('shopingcart',$shopingcart);			 			echo '<script language="javascript"> alert("Th√™m th√†nh c√¥ng");window.location.replace("'.DOMAIN.$url.'"); </script>';		 }	     else		 {					 		$shopingcart[$id]['pid'] = $id;						$product=$this->Product->findById($id); 				$shopingcart[$id]['name']=$product['Product']['name'];					$shopingcart[$id]['images']=$product['Product']['images'];					$shopingcart[$id]['sl']=1;				//$shopingcart[$id]['user_id']=$product['Product']['user_id'];				$shopingcart[$id]['price'] = $product['Product']['price'];								$shopingcart[$id]['total']= $product['Product']['price']*$shopingcart[$id]['sl'];				//pr($shopingcart);								$this->Session->write('shopingcart',$shopingcart);						//pr($this->Session->read('shopingcart')); die;								echo '<script language="javascript" type="text/javascript"> alert("Th√™m gi·ªè h√†ng th√†nh c√¥ng"); window.location.replace("'.DOMAIN.$url.'"); </script>';	         }	 					//die;	} 	function deleteshopingcart($id=null){		if(isset($_SESSION['shopingcart']))		 {   			 $shopingcart=$_SESSION['shopingcart'];			 			  if(isset($shopingcart[$id]))			  unset($shopingcart[$id]);			  $_SESSION['shopingcart']=$shopingcart;                              $pr=$this->Product->findById($id);                                $this->Product->save($pr);              			echo '<script language="javascript" type="text/javascript"> window.location.replace("'.DOMAIN.'gio-hang"); </script>';	          		 }			}		function deleteshopingcart1($id=null){		$this->Session->delete('shopingcart'); die;		if(isset($_SESSION['shopingcart']))		 {   			 $shopingcart=$_SESSION['shopingcart'];			 			  if(isset($shopingcart[$id]))			  unset($shopingcart[$id]);			  $_SESSION['shopingcart']=$shopingcart;                              $pr=$this->Product->findById($id);                //$pr['Product']['daban']= $pr['Product']['daban'] - $value['sl'];                $this->Product->save($pr);              			echo '<script language="javascript" type="text/javascript"> window.location.replace("'.DOMAIN.'dat-mua#gh"); </script>';	          		 }			}	    function viewshopingcart(){              //pr($this->Session->read('shopingcart')); die;	        if($this->Session->check('shopingcart'))		 {   			 $shopingcart=$this->Session->read('shopingcart');			 			 $this->set(compact('shopingcart'));		 }		 else		 {			 echo '<script language="javascript"> alert("Chua cÛ s?n ph?m n‡o trong gi? h‡ng"); window.location.replace("'.DOMAIN.'"); </script>';		 }	}	function updateshopingcart($id=null){				if(isset($_SESSION['shopingcart']))		 {   			 $shopingcart=$_SESSION['shopingcart'];			 			  if(isset($shopingcart[$id]))			  {				  $shopingcart[$id]['sl']=$_POST['soluong'];							  echo $_POST['soluong'];			die;				  $shopingcart[$id]['total']= $shopingcart[$id]['sl']*$shopingcart[$id]['price'];			  }			  $_SESSION['shopingcart']=$shopingcart;			 				echo '<script language="javascript" type="text/javascript"> window.location.replace("'.DOMAIN.'gio-hang"); </script>';		 }	}				function updateshopingcart1($id=null,$soluong=null){				if($this->Session->check('shopingcart'))		 {   			 $shopingcart=$this->Session->read('shopingcart');			 			  if(isset($shopingcart[$id]))			  {				  $shopingcart[$id]['sl']=$soluong;				  $shopingcart[$id]['total']= $shopingcart[$id]['sl']*$shopingcart[$id]['price'];			  }			  $this->Session->write('shopingcart',$shopingcart);						$this->redirect(DOMAIN.'gio-hang');		 }	}			function updateshopingcart2($id=null,$soluong=null){				if(isset($_SESSION['shopingcart']))		 {   			 $shopingcart=$_SESSION['shopingcart'];			 			  if(isset($shopingcart[$id]))			  {				  $shopingcart[$id]['sl']=$soluong;				  $shopingcart[$id]['total']= $shopingcart[$id]['sl']*$shopingcart[$id]['price'];			  }			  $_SESSION['shopingcart']=$shopingcart;						echo '<script language="javascript" type="text/javascript"> window.location.replace("'.DOMAIN.'dat-mua#gh"); </script>';		 }	}	//End SHOPPING		function datmua(){  if(isset($_SESSION['shopingcart']))		 {   			 $shopingcart=$_SESSION['shopingcart'];			 			 $this->set(compact('shopingcart'));			 // pr($shopingcart); die;		 }		 else		 {			 echo '<script language="javascript"> alert("Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè"); window.location.replace("'.DOMAIN.'"); </script>';		 }		 	if(isset($_POST['name'])) {	$name=isset($_POST['name'])? $_POST['name'] :'';		$phone=isset($_POST['phone'])? $_POST['phone'] :'';		$email1=isset($_POST['email'])? $_POST['email'] :'';		$address=isset($_POST['address'])? $_POST['address'] :'';		$title=isset($_POST['title'])? $_POST['title'] :'';		$content=isset($_POST['content'])? $_POST['content'] :'';				$order=''; $tong=0;	 foreach( $shopingcart as $row){				$order.="<tr><td><img src=".DOMAINAD."timthumb.php?src=".$row['images']. " '/></td><td>".$row['name']."</td>"."<td>".$row['sl']."</td>"."<td>".number_format($row['price'])."</td>"."<td>".number_format($row['total'])."</td></tr>";		$tong+=$row['total'];			 }	// pr($a); die;	 		//pr($key);	//echo $key;	$email=array('Email'=>array(					'name'=>$name,					'phone'=>$phone,					'email'=>$email1,					'address'=>$address,					'title'=>$title,					'content'=>$content,									'order'=>'<table style="border-collapse:collapse; margin-top:10px; width:100%;" border="1"><tr><td>H√¨nh ·∫£nh</td><td>T√™n s·∫£n ph·∫©m</td><td>S·ªë l∆∞·ª£ng</td><td>Gi√° s·∫£n ph·∫©m</td><td>T·ªïng ti·ªÅn</td>'.$order.' <tr><td colspan="4" style="text-align:right;"> T·ªïng ti·ªÅn ph·∫£i tr·∫£:</td><td>'.number_format($tong).'</td></tr></table>',							)	);		$this->Email->save($email);	unset($_SESSION['shopingcart']);	echo '<script language="javascript" type="text/javascript"> alert("ƒê·∫∑t h√†ng th√†nh c√¥ng"); window.location.replace("'.DOMAIN.'");</script>';			 	}	 }	function get_total(){	  $total=0;	  	 if($this->Session->check('shopingcart'))	{		$shopingcart=$this->Session->read('shopingcart');			 foreach($shopingcart as $key=>$row) 			 {					$total+=$row['total'];			 }	 }	 return $total;	}		function count_sp(){	$total=0;	 if($this->Session->check('shopingcart'))	{		$shopingcart=$this->Session->read('shopingcart');			foreach($shopingcart as $key=>$row) {			$total++;			}	 }		 return $total;	}			public function loc($id=1){				        switch ($id) {            case '1' :									 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,			  'Product.price >'=>5000000,			  'Product.price <'=>15000000,           			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );		        $listProduct = $this->paginate('Product');		$title="Danh s√°ch s·∫£n ph·∫©m t·ª´ 5.000.000ƒë ƒë·∫øn 15.000.000ƒë";		break;				  case '2' :									 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,			  'Product.price >'=>15000000,			  'Product.price <'=>20000000,           			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );		        $listProduct = $this->paginate('Product');		$title="Danh s√°ch s·∫£n ph·∫©m t·ª´ 15.000.000ƒë ƒë·∫øn 20.000.000ƒë";		break;				  case '3' :									 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,			  'Product.price >'=>20000000,			  'Product.price <'=>25000000,           			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );		        $listProduct = $this->paginate('Product');		$title="Danh s√°ch s·∫£n ph·∫©m t·ª´ 20.000.000ƒë ƒë·∫øn 25.000.000ƒë";		break;				  case '4' :									 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,			  'Product.price >'=>25000000,			  'Product.price <'=>30000000,           			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );		$title="Danh s√°ch s·∫£n ph·∫©m t·ª´ 25.000.000ƒë ƒë·∫øn 30.000.000ƒë";        $listProduct = $this->paginate('Product');		break;				case '5' :									 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,			  'Product.price >'=>30000000,			  'Product.price <'=>50000000,           			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );		$title="Danh s√°ch s·∫£n ph·∫©m t·ª´ 30.000.000ƒë ƒë·∫øn 50.000.000ƒë";        $listProduct = $this->paginate('Product');		break;						case '5' :									 // list all product        $this->paginate = array(            'conditions' => array(              'Product.status' => 1,			  'Product.price >'=>50000000,			              ),            'order' => 'Product.pos DESC, Product.modified DESC',            'limit' => '12'        );		        $listProduct = $this->paginate('Product');		$title="Danh s√°ch s·∫£n ph·∫©m tr√™n 50.000.000ƒë";		break;				}         		 $this->set('product',$listProduct);		 $this->set('title_1',$title);		 			}			public function search(){			$search_product='';			if(isset($_POST['keyword'])) 			{				$this->Session->write('search_product',$search_product);				$search_product=$_POST['keyword'];			}			elseif($this->Session->check('search_product')) 			{				$search_product=$this->Session->read('search_product');			}															$a=$this->Product->find('all', array('conditions'=>array('Product.status'=>1,'Product.name like'=>'%'.$search_product.'%')));						$this->paginate = array('conditions'=>array('Product.status'=>1,'Product.name like'=>'%'.$search_product.'%'),'limit'=>16);			$this->set('product', $this->paginate('Product',array()));			$this->set('txt',$search_product);			$this->set('result', count($a));		}		}